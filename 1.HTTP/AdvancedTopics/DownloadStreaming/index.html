<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Tivadar GyÃ¶rgy Nagy">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Download Streaming - Best HTTP/2 Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Download Streaming";
    var mkdocs_page_input_path = "1.HTTP\\AdvancedTopics\\DownloadStreaming.md";
    var mkdocs_page_url = "/5sb/1.HTTP/AdvancedTopics/DownloadStreaming/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Best HTTP/2 Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../ThirdPartyNotices/">Third-Party Notices</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../UpgradeGuide/">UpgradeGuide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../changelog/">Changelog</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../platforms/">Platforms</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">1.HTTP</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../GettingStarted/">Getting Started Quickly</a>
                </li>
                <li class="">
                    
    <a class="" href="../../HTTPRequest/">HTTPRequest</a>
                </li>
                <li class="">
                    
    <a class="" href="../../HTTPResponse/">HTTPResponse</a>
                </li>
                <li class=" current">
                    
    <span class="caption-text">AdvancedTopics</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../Async-await/">Async-Await with HTTPRequest</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Authentication/">Authentication</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Caching/">Caching</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Cookies/">Cookies</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../DownloadProgress/">Download Progress Tracking</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">Download Streaming</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#download-streaming">Download Streaming</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#streaming-into-a-file">Streaming into a file</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../ErrorHandling/">ErrorHandling</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Redirections/">Control Redirections</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Request.Abort/">Aborting a Request</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../RequestStates/">Request States</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../ServerCertificateValidation/">Server Certificate Validation</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../SmallCode-Samples/">Small Code-Samples</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Timeouts/">Timeouts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../Timing/">Timing API</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../UploadProgress/">Upload Progress Tracking</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../UploadStreaming/">Upload Streaming</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">2.WebSocket</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../2.WebSocket/">Index</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">3.1Socket.IO3</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../3.1Socket.IO3/">Socket.IO 3</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">3.Socket.IO</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/">SocketIO</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/1.Namespaces/">Connecting to namespaces</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/2.ReceivingEvents/">Subscribing and receiving events</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/3.SendingEvents/">Sending events</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/4.DefaultEncoder/">Set the default Json encoder</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/5.CustomEncoder/">Writing a custom Json encoder</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/6.AutoDecodePayload/">AutoDecodePayload</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/7.ErrorHandling/">Error handling</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../3.Socket.IO/8.Options/">The SocketOptions class</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">4.SignalR</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../4.SignalR/">Index</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../4.SignalR/1.Connection/">The Connection class</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../4.SignalR/2.GeneralEvents/">Handling general events</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../4.SignalR/3.Sending/">Sending non-Hub messages</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../4.SignalR/4.Hubs/">Hubs</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">5.EventSource</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../5.EventSource/">Server-Sent Events (EventSource)</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">6.SignalRCore</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/">SignalR Core</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/1.HubConnection/">The HubConnection Class</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/2.Authentication/">The IAuthenticationProvider interface</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/3.Encoders/">Encoders</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/4.IRetryPolicy/">Automatic reconnection and the IRetryPolicy interface</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../6.SignalRCore/5.AzureSignalRService/">How to connect to an Azure SignalR Service</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">7.GlobalTopics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/BufferPool/">Buffer Pool</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/ConnectionPool/">Connection Pooling</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/GlobalSettings/">Global Settings</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/HTTP2/">HTTP/2</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/HTTPS/">HTTPS</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/HowToDisableFeatures/">How to disable features</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/Logging/">Logging</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/Proxy/">Proxies</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../7.GlobalTopics/ThreadSafety/">ThreadSafety</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">8.Addons</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">TLSSecurity</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../8.Addons/TLSSecurity/">About</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../8.Addons/TLSSecurity/CertificationManagerWindow/">CertificationManagerWindow</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../8.Addons/TLSSecurity/Options/">SecurityOptions</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">cURLParser</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../8.Addons/cURLParser/">Index</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Best HTTP/2 Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>AdvancedTopics &raquo;</li>
        
      
        
          <li>1.HTTP &raquo;</li>
        
      
    
    <li>Download Streaming</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="download-streaming">Download Streaming</h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Not available under the WebGL runtime. See <a href="../../../platforms/">platforms and limitations section for more details</a></p>
</div>
<p>For larger responses it's not advised to keep the whole entity in memory. To be able process downloaded data as soon as received the plugin provides the <code>OnStreamingData</code> callback. </p>
<pre><code class="language-csharp">var request = new HTTPRequest(new Uri(&quot;...&quot;), OnRequestFinished);
request.OnStreamingData += OnDataDownloaded;

bool OnDataDownloaded(HTTPRequest request, HTTPResponse response, byte[] dataFragment, int dataFragmentLength)
{
    // Use downloaded data

    return true;
}
</code></pre>

<p>The callback's parameters are the following:</p>
<ul>
<li><strong>request</strong>: the original <code>HTTPRequest</code> object</li>
<li><strong>response</strong>: the <code>HTTPResponse</code> object the data belongs to. Through this object all already received information can be accessed (status code, headers, etc.)</li>
<li><strong>dataFragment</strong>: the actual downloaded bytes. Because the plugin reuses byte arrays, its length can be larger than the downloaded data, so instead of <code>dataFragment.Length</code> the <code>dataFragmentLength</code> parameter must be used!</li>
<li><strong>dataFragmentLength</strong>: the real downloaded byte count of the dataFragment parameter. Use this parameter instead of <code>dataFragment.Length</code>!</li>
</ul>
<p>The callback also must return <code>true</code> or <code>false</code> depending on whether the plugin can reuse the <code>dataFragment</code> buffer or not. For more details see the <a href="../../../7.GlobalTopics/BufferPool/">BufferPool documentation</a>.
So in case the dataFragment's reference is kept by user code, the callback must return false:</p>
<pre><code class="language-csharp">var request = new HTTPRequest(new Uri(&quot;...&quot;), OnRequestFinished);
request.OnStreamingData += OnDataDownloaded;

List&lt;Data&gt; dataToProcess = new List&lt;Data&gt;();
bool OnDataDownloaded(HTTPRequest request, HTTPResponse response, byte[] dataFragment, int dataFragmentLength)
{
    // dataFragment is saved to process it later
    dataToProcess.Add(new Data { 
        buffer = dataFragment, 
        length = dataFragmentLength 
    });

    // so the callback must return false, otherwise the plugin would reuse the byte[] overwriting the data in it
    return false;
}

struct Data
{
    public byte[] buffer;
    public int length;
}
</code></pre>

<p>Size of the <code>dataFragment</code> (== <code>dataFragmentLength</code>) depends on various factors:</p>
<ol>
<li>Value of the <code>StreamFragmentSize</code> property. The plugin tries to keep the fragments' size around <code>StreamFragmentSize</code>, but the BufferPool can return a larger chunks of memory.</li>
<li>If <code>StreamChunksImmediately</code> is <code>true</code>, then no buffering will be done. In case of chunked content-encoding the size of the fragment is the chunk length. In case there's a content-length header, the plugin fills up an at least <code>HTTPResponse.MinBufferSize</code>d buffer for the next fragment.</li>
</ol>
<p>Because there's a time window between producing dataFragments and consuming them in an <code>OnStreamingData</code> callback, to prevent consuming too much memory there's a hard limit on the queued dataFragments. When this hard limit is reached the reader thread stops producing new fragments and resumes as soon as there's free slots in the queue. This hard limit can be changed through the <code>MaxFragmentQueueLength</code> property. So, the maximum amount of memory the plugin will consme for streaming is about (<code>MaxFragmentQueueLength</code> * <code>StreamFragmentSize</code>).<br>
With HTTP/2, the reading thread doesn't know the semantics of the frames it reads from the stream, so it can't limit what and how many frames/data it reads (it would also block the reading of other frames too). To limit a HTTP/2 stream and/or the whole HTTP/2 connection <a href="../../../7.GlobalTopics/HTTP2/"><code>HTTPManager.HTTP2Settings</code></a>' <code>InitialStreamWindowSize</code> and <code>InitialConnectionWindowSize</code> can be used.</p>
<h2 id="streaming-into-a-file">Streaming into a file</h2>
<p>In the following example the <code>FileStream</code> is created on-demand and its reference is stored in the request's Tag property to reuse the instance instead of reopening the file every time.</p>
<pre><code class="language-csharp">var request = new HTTPRequest(new Uri(url), OnRequestFinished);

request.OnStreamingData += OnData;

request.Send();

private bool OnData(HTTPRequest req, HTTPResponse resp, byte[] dataFragment, int dataFragmentLength)
{
    if (resp.IsSuccess)
    {
        var fs = req.Tag as System.IO.FileStream;
        if (fs == null)
            req.Tag = fs = new System.IO.FileStream(&quot;fileName&quot;, System.IO.FileMode.Create);

        fs.Write(dataFragment, 0, dataFragmentLength);
    }

    // Return true if dataFragment is processed so the plugin can recycle it
    return true;
}

private void OnRequestFinished(HTTPRequest req, HTTPResponse resp)
{
    var fs = req.Tag as System.IO.FileStream;
    if (fs != null)
        fs.Dispose();

    switch (req.State)
    {
        // The request finished without any problem.
        case HTTPRequestStates.Finished:
            if (resp.IsSuccess)
            {
                Debug.Log(&quot;Done!&quot;);
            }
            else
            {
                Debug.LogWarning(string.Format(&quot;Request finished Successfully, but the server sent an error. Status Code: {0}-{1} Message: {2}&quot;,
                                                resp.StatusCode,
                                                resp.Message,
                                                resp.DataAsText));
            }
            break;

        default:
                // There were an error while downloading the content.
                // The incomplete file should be deleted.
                System.IO.File.Delete(&quot;filename&quot;);
            break;
    }
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ErrorHandling/" class="btn btn-neutral float-right" title="ErrorHandling">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../DownloadProgress/" class="btn btn-neutral" title="Download Progress Tracking"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../DownloadProgress/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../ErrorHandling/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>

</body>
</html>
